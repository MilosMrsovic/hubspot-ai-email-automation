{
  "name": "Automated Personalized Email",
  "nodes": [
    {
      "parameters": {
        "fileSelector": "/data/***.csv",
        "options": {}
      },
      "type": "n8n-nodes-base.readWriteFile",
      "typeVersion": 1,
      "position": [
        -38816,
        -2624
      ],
      "id": "0f1fc425-1388-4478-ba72-e184441226f7",
      "name": "Read/Write Files from Disk1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -38592,
        -2624
      ],
      "id": "5191f61c-2fa4-4f87-a118-238d9c609c37",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "fieldToSplitOut": "rfm_recency, rfm_frequency, rfm_monetary, last_viewed, favorite_content_topics, lifecyclestage, industry, email, firstname, purchase_value",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -38368,
        -2624
      ],
      "id": "cc23cba7-e1ba-471f-b12a-631050440e2f",
      "name": "Split Out"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -38144,
        -2624
      ],
      "id": "2f4fd060-007e-4002-a148-5646d6173e2b",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=SYSTEM_PROMPT: You are an expert direct marketing and e-commerce copywriter. Your task is to generate the body of a highly personalized email, strictly in English, based on the provided client metrics. Write in a friendly and direct tone, focusing on a clear call-to-action. Do not include the Subject Line, Signature, or Salutation (e.g., \"Hi [Name]\").\n\nUSER_DATA: Analyze the following data for personalization:\n1. First Name: {{ $json.firstname }}\n2. Email: {{ $json.email }}\n3. Lifecycle Stage: {{ $json.lifecyclestage }}\n4. Industry: {{ $json.industry }}\n5. RFM Recency (R): {{ $json.rfm_recency }}\n6. RFM Frequency (F): {{ $json.rfm_frequency }}\n7. RFM Monetary (M): {{ $json.rfm_monetary }}\n8. Last Purchase Value: {{ $json.purchase_value }}\n9. Last Viewed Product: {{ $json.last_viewed }}\n10. Favorite Topics/Categories: {{ $json.favorite_content_topics }}\n\nUSER_INSTRUCTION:\nGenerate the email body text only, using the following logic:\n* If Recency (R) is high (e.g., R > 90) AND Lifecycle Stage is 'Customer': Focus on a win-back or re-engagement offer (e.g., a discount code).\n* If Recency (R) is low AND Frequency (F) is high: Focus on rewarding loyalty and introduce new, relevant products.\n* If 'last_viewed' is populated: Reference that product immediately and provide helpful or related content.\n* If 'last_viewed' is empty and Recency is low: Recommend a top seller in the '{{ $json.favorite_content_topics }}' category.\n\nGenerate only the email body text. Do not include any introduction or meta-text. Start the email with \"Hi {{ $json.firstname }},\".\n\nDo not include placeholders such as [insert CTA button], [link], or similar. Write natural call-to-actions in plain text.\n\nThe email must end exactly with \"Best Regards,\" followed by a line break and nothing else. Do NOT add any letters, initials, names, symbols, or additional text after the comma.\n",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        -37952,
        -2432
      ],
      "id": "742424f4-4a47-4d5c-96ae-3b83181c5fe6",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": "llama3.1:latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -38064,
        -2256
      ],
      "id": "3045dc4a-2514-4122-8f5c-6cc4b5fa7e39",
      "name": "Ollama Chat Model",
      "credentials": {
        "ollamaApi": {
          "id": "***",
          "name": "***"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ $('Loop Over Items').item.json.email }}",
        "subject": "={{ $json.output }}",
        "emailType": "text",
        "message": "={{ $('AI Agent').item.json.output }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -37088,
        -2336
      ],
      "id": "01e18729-e9dd-4ee9-9e57-2b16f005c862",
      "name": "Send a message",
      "webhookId": "***",
      "credentials": {
        "gmailOAuth2": {
          "id": "***",
          "name": "***"
        }
      }
    },
    {
      "parameters": {
        "authentication": "appToken",
        "email": "={{ $('Loop Over Items').item.json.email }}",
        "additionalFields": {
          "leadStatus": "CONNECTED"
        },
        "options": {
          "resolveData": false
        }
      },
      "type": "n8n-nodes-base.hubspot",
      "typeVersion": 2.2,
      "position": [
        -36880,
        -2272
      ],
      "id": "a06834ab-4d51-46da-b927-88f552f15872",
      "name": "Create or update a contact",
      "credentials": {
        "hubspotAppToken": {
          "id": "***",
          "name": "***"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "***",
          "mode": "list",
          "cachedResultName": "Inventory Data",
          "cachedResultUrl": "***"
        },
        "sheetName": {
          "__rl": true,
          "value": "***",
          "mode": "list",
          "cachedResultName": "Log sheet",
          "cachedResultUrl": "***"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "={{ $json.formattedDate }}",
            "nodeName": "={{ $('Edit Fields').item.json.nodeName }}",
            "errorMessage": "={{ $('Edit Fields').item.json.errorMessage }}",
            "workflowName": "={{ $('Edit Fields').item.json.workflowName }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "nodeName",
              "displayName": "nodeName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "errorMessage",
              "displayName": "errorMessage",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "workflowName",
              "displayName": "workflowName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -38304,
        -1920
      ],
      "id": "2d5bfdfc-6fdc-4784-a1ed-beb9cc1e3cc1",
      "name": "Append row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "***",
          "name": "***"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rows = $json.table;\n\nlet html = `\n<table border=\"1\" cellpadding=\"6\" cellspacing=\"0\" style=\"border-collapse: collapse;\">\n  <tr>\n    <th>Firstname</th>\n    <th>Email</th>\n  </tr>\n`;\n\nfor (const row of rows) {\n  html += `\n  <tr>\n    <td>${row.firstname}</td>\n    <td>${row.email}</td>\n  </tr>\n  `;\n}\n\nhtml += `</table>`;\n\nreturn [\n  {\n    json: {\n      html_table: html\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -37696,
        -2720
      ],
      "id": "a701e53e-800e-4e42-b484-e31493761b40",
      "name": "Code in JavaScript1"
    }
  ],
  "connections": {
    "Read/Write Files from Disk1": { "main": [[{"node": "Extract from File","type":"main","index":0}]] },
    "Extract from File": { "main": [[{"node": "Split Out","type":"main","index":0}]] },
    "Split Out": { "main": [[{"node": "Loop Over Items","type":"main","index":0}]] },
    "Loop Over Items": { "main": [[{"node": "Aggregate4","type":"main","index":0}], [{"node": "AI Agent","type":"main","index":0}]] },
    "Ollama Chat Model": { "ai_languageModel": [[{"node": "AI Agent","type":"ai_languageModel","index":0}]] },
    "AI Agent": { "main": [[{"node": "AI Agent1","type":"main","index":0}]] },
    "Send a message": { "main": [[{"node": "Create or update a contact","type":"main","index":0}]] },
    "AI Agent1": { "main": [[{"node": "Wait","type":"main","index":0}]] },
    "Create or update a contact": { "main": [[{"node": "Edit Fields1","type":"main","index":0}]] },
    "Edit Fields1": { "main": [[{"node": "Loop Over Items","type":"main","index":0}]] },
    "Aggregate4": { "main": [[{"node": "Code in JavaScript1","type":"main","index":0}]] },
    "Code in JavaScript1": { "main": [[{"node": "Send a message2","type":"main","index":0}]] }
  },
  "active": true,
  "versionId": "***",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "***"
  },
  "id": "***",
  "tags": []
}
